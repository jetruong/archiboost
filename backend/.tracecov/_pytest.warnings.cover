       # mypy: allow-untyped-defs
    1: from __future__ import annotations
       
    1: from collections.abc import Generator
    1: from contextlib import contextmanager
    1: from contextlib import ExitStack
    1: import sys
    1: from typing import Literal
    1: import warnings
       
    1: from _pytest.config import apply_warning_filters
    1: from _pytest.config import Config
    1: from _pytest.config import parse_warning_filter
    1: from _pytest.main import Session
    1: from _pytest.nodes import Item
    1: from _pytest.terminal import TerminalReporter
    1: from _pytest.tracemalloc import tracemalloc_message
    1: import pytest
       
       
    2: @contextmanager
    7: def catch_warnings_for_item(
    1:     config: Config,
           ihook,
    1:     when: Literal["config", "collect", "runtest"],
    1:     item: Item | None,
           *,
    2:     record: bool = True,
    1: ) -> Generator[None]:
           """Context manager that catches warnings generated in the contained execution block.
       
           ``item`` can be None if we are not in the context of an item execution.
       
           Each warning captured triggers the ``pytest_warning_recorded`` hook.
           """
   94:     config_filters = config.getini("filterwarnings")
   94:     cmdline_filters = config.known_args_namespace.pythonwarnings or []
  188:     with warnings.catch_warnings(record=record) as log:
   94:         if not sys.warnoptions:
                   # If user is not explicitly configuring warning filters, show deprecation warnings by default (#2908).
   94:             warnings.filterwarnings("always", category=DeprecationWarning)
   94:             warnings.filterwarnings("always", category=PendingDeprecationWarning)
       
   94:         warnings.filterwarnings("error", category=pytest.PytestRemovedIn9Warning)
       
   94:         apply_warning_filters(config_filters, cmdline_filters)
       
               # apply filters from "filterwarnings" marks
   94:         nodeid = "" if item is None else item.nodeid
   94:         if item is not None:
   89:             for mark in item.iter_markers(name="filterwarnings"):
>>>>>>                 for arg in mark.args:
>>>>>>                     warnings.filterwarnings(*parse_warning_filter(arg, escape=False))
       
   94:         try:
   94:             yield
               finally:
   94:             if record:
                       # mypy can't infer that record=True means log is not None; help it.
   93:                 assert log is not None
       
  100:                 for warning_message in log:
   14:                     ihook.pytest_warning_recorded.call_historic(
   14:                         kwargs=dict(
    7:                             warning_message=warning_message,
    7:                             nodeid=nodeid,
    7:                             when=when,
    7:                             location=None,
                               )
                           )
       
       
    1: def warning_record_to_str(warning_message: warnings.WarningMessage) -> str:
           """Convert a warnings.WarningMessage to a string."""
   21:     return warnings.formatwarning(
    7:         str(warning_message.message),
    7:         warning_message.category,
    7:         warning_message.filename,
    7:         warning_message.lineno,
    7:         warning_message.line,
    7:     ) + tracemalloc_message(warning_message.source)
       
       
    2: @pytest.hookimpl(wrapper=True, tryfirst=True)
    2: def pytest_runtest_protocol(item: Item) -> Generator[None, object, object]:
  267:     with catch_warnings_for_item(
   89:         config=item.config, ihook=item.ihook, when="runtest", item=item
           ):
   89:         return (yield)
       
       
    2: @pytest.hookimpl(wrapper=True, tryfirst=True)
    2: def pytest_collection(session: Session) -> Generator[None, object, object]:
    1:     config = session.config
    3:     with catch_warnings_for_item(
    1:         config=config, ihook=config.hook, when="collect", item=None
           ):
    1:         return (yield)
       
       
    2: @pytest.hookimpl(wrapper=True)
    4: def pytest_terminal_summary(
    1:     terminalreporter: TerminalReporter,
    1: ) -> Generator[None]:
    1:     config = terminalreporter.config
    3:     with catch_warnings_for_item(
    1:         config=config, ihook=config.hook, when="config", item=None
           ):
    1:         return (yield)
       
       
    2: @pytest.hookimpl(wrapper=True)
    2: def pytest_sessionfinish(session: Session) -> Generator[None]:
    1:     config = session.config
    3:     with catch_warnings_for_item(
    1:         config=config, ihook=config.hook, when="config", item=None
           ):
    1:         return (yield)
       
       
    2: @pytest.hookimpl(wrapper=True)
    4: def pytest_load_initial_conftests(
    1:     early_config: Config,
    1: ) -> Generator[None]:
    3:     with catch_warnings_for_item(
    1:         config=early_config, ihook=early_config.hook, when="config", item=None
           ):
    1:         return (yield)
       
       
    1: def pytest_configure(config: Config) -> None:
    2:     with ExitStack() as stack:
    2:         stack.enter_context(
    2:             catch_warnings_for_item(
    1:                 config=config,
    1:                 ihook=config.hook,
    1:                 when="config",
    1:                 item=None,
                       # this disables recording because the terminalreporter has
                       # finished by the time it comes to reporting logged warnings
                       # from the end of config cleanup. So for now, this is only
                       # useful for setting a warning filter with an 'error' action.
    1:                 record=False,
                   )
               )
    2:         config.addinivalue_line(
    1:             "markers",
    1:             "filterwarnings(warning): add a warning filter to the given test. "
                   "see https://docs.pytest.org/en/stable/how-to/capture-warnings.html#pytest-mark-filterwarnings ",
               )
    1:         config.add_cleanup(stack.pop_all().close)
