    1: """Azure Key Vault settings source."""
       
    1: from __future__ import annotations as _annotations
       
    1: from collections.abc import Iterator, Mapping
    1: from typing import TYPE_CHECKING
       
    1: from pydantic.alias_generators import to_snake
    1: from pydantic.fields import FieldInfo
       
    1: from .env import EnvSettingsSource
       
    1: if TYPE_CHECKING:
>>>>>>     from azure.core.credentials import TokenCredential
>>>>>>     from azure.core.exceptions import ResourceNotFoundError
>>>>>>     from azure.keyvault.secrets import SecretClient
       
>>>>>>     from pydantic_settings.main import BaseSettings
       else:
    1:     TokenCredential = None
    1:     ResourceNotFoundError = None
    1:     SecretClient = None
       
       
    1: def import_azure_key_vault() -> None:
           global TokenCredential
           global SecretClient
           global ResourceNotFoundError
       
>>>>>>     try:
>>>>>>         from azure.core.credentials import TokenCredential
>>>>>>         from azure.core.exceptions import ResourceNotFoundError
>>>>>>         from azure.keyvault.secrets import SecretClient
>>>>>>     except ImportError as e:  # pragma: no cover
>>>>>>         raise ImportError(
>>>>>>             'Azure Key Vault dependencies are not installed, run `pip install pydantic-settings[azure-key-vault]`'
>>>>>>         ) from e
       
       
    2: class AzureKeyVaultMapping(Mapping[str, str | None]):
    1:     _loaded_secrets: dict[str, str | None]
    1:     _secret_client: SecretClient
    1:     _secret_names: list[str]
       
    5:     def __init__(
               self,
    1:         secret_client: SecretClient,
    1:         case_sensitive: bool,
    1:         snake_case_conversion: bool,
    1:     ) -> None:
>>>>>>         self._loaded_secrets = {}
>>>>>>         self._secret_client = secret_client
>>>>>>         self._case_sensitive = case_sensitive
>>>>>>         self._snake_case_conversion = snake_case_conversion
>>>>>>         self._secret_map: dict[str, str] = self._load_remote()
       
    1:     def _load_remote(self) -> dict[str, str]:
>>>>>>         secret_names: Iterator[str] = (
>>>>>>             secret.name for secret in self._secret_client.list_properties_of_secrets() if secret.name and secret.enabled
               )
       
>>>>>>         if self._snake_case_conversion:
>>>>>>             return {to_snake(name): name for name in secret_names}
       
>>>>>>         if self._case_sensitive:
>>>>>>             return {name: name for name in secret_names}
       
>>>>>>         return {name.lower(): name for name in secret_names}
       
    1:     def __getitem__(self, key: str) -> str | None:
>>>>>>         new_key = key
       
>>>>>>         if self._snake_case_conversion:
>>>>>>             new_key = to_snake(key)
>>>>>>         elif not self._case_sensitive:
>>>>>>             new_key = key.lower()
       
>>>>>>         if new_key not in self._loaded_secrets:
>>>>>>             if new_key in self._secret_map:
>>>>>>                 self._loaded_secrets[new_key] = self._secret_client.get_secret(self._secret_map[new_key]).value
                   else:
>>>>>>                 raise KeyError(key)
       
>>>>>>         return self._loaded_secrets[new_key]
       
    1:     def __len__(self) -> int:
>>>>>>         return len(self._secret_map)
       
    1:     def __iter__(self) -> Iterator[str]:
>>>>>>         return iter(self._secret_map.keys())
       
       
    2: class AzureKeyVaultSettingsSource(EnvSettingsSource):
    1:     _url: str
    1:     _credential: TokenCredential
       
   11:     def __init__(
               self,
    1:         settings_cls: type[BaseSettings],
    1:         url: str,
    1:         credential: TokenCredential,
    2:         dash_to_underscore: bool = False,
    2:         case_sensitive: bool | None = None,
    2:         snake_case_conversion: bool = False,
    2:         env_prefix: str | None = None,
    2:         env_parse_none_str: str | None = None,
    2:         env_parse_enums: bool | None = None,
    1:     ) -> None:
>>>>>>         import_azure_key_vault()
>>>>>>         self._url = url
>>>>>>         self._credential = credential
>>>>>>         self._dash_to_underscore = dash_to_underscore
>>>>>>         self._snake_case_conversion = snake_case_conversion
>>>>>>         super().__init__(
>>>>>>             settings_cls,
>>>>>>             case_sensitive=False if snake_case_conversion else case_sensitive,
>>>>>>             env_prefix=env_prefix,
>>>>>>             env_nested_delimiter='__' if snake_case_conversion else '--',
>>>>>>             env_ignore_empty=False,
>>>>>>             env_parse_none_str=env_parse_none_str,
>>>>>>             env_parse_enums=env_parse_enums,
               )
       
    1:     def _load_env_vars(self) -> Mapping[str, str | None]:
>>>>>>         secret_client = SecretClient(vault_url=self._url, credential=self._credential)
>>>>>>         return AzureKeyVaultMapping(
>>>>>>             secret_client=secret_client,
>>>>>>             case_sensitive=self.case_sensitive,
>>>>>>             snake_case_conversion=self._snake_case_conversion,
               )
       
    1:     def _extract_field_info(self, field: FieldInfo, field_name: str) -> list[tuple[str, str, bool]]:
>>>>>>         if self._snake_case_conversion:
>>>>>>             return list((x[0], x[0], x[2]) for x in super()._extract_field_info(field, field_name))
       
>>>>>>         if self._dash_to_underscore:
>>>>>>             return list((x[0], x[1].replace('_', '-'), x[2]) for x in super()._extract_field_info(field, field_name))
       
>>>>>>         return super()._extract_field_info(field, field_name)
       
    1:     def __repr__(self) -> str:
>>>>>>         return f'{self.__class__.__name__}(url={self._url!r}, env_nested_delimiter={self.env_nested_delimiter!r})'
       
       
    1: __all__ = ['AzureKeyVaultMapping', 'AzureKeyVaultSettingsSource']
